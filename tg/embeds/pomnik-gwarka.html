<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Pomnik Gwarka</title>
    <link rel="stylesheet" href="embeds.css" />

    <style>
      /* Minimal layout styling in case embeds.css is sparse */
      .card {
        max-width: 720px;
        margin: 24px auto;
        padding: 20px;
        border-radius: 16px;
        border: 1px solid rgba(0, 0, 0, 0.12);
        background: white;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      }
      .muted {
        opacity: 0.75;
      }
      .image-slot {
        width: 100%;
        height: 420px;
        border-radius: 14px;
        border: 1px dashed rgba(0, 0, 0, 0.25);
        display: flex;
        align-items: center;
        justify-content: center;
        overflow: hidden;
        background: rgba(0, 0, 0, 0.03);
        margin: 12px 0 16px;
      }
      .image-slot img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: none; /* shows only if you set a src in JS */
      }
      .miner-text {
        font-size: 1.05rem;
        line-height: 1.5;
        margin: 12px 0 18px;
        white-space: pre-wrap;
      }
      .options {
        display: grid;
        gap: 10px;
        margin-top: 12px;
      }
      .options button {
        width: 100%;
        text-align: left;
        padding: 12px 14px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: white;
        cursor: pointer;
        font-size: 1rem;
      }
      .options button:hover {
        background: rgba(0, 0, 0, 0.04);
      }
      .row {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap;
        margin-top: 10px;
      }
      .small-btn {
        padding: 10px 12px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.18);
        background: white;
        cursor: pointer;
      }
    </style>
  </head>

  <body>
    <div class="card">
      <h1>ðŸ—¿ Pomnik Gwarka</h1>
      <p class="muted">
        Talk to the old miner. Choose options to follow the story.
      </p>

      <!-- Space on top for a picture -->
      <div class="image-slot" id="imageSlot" aria-label="Miner image area">
        <img id="minerImg" alt="Miner" />
        <span class="muted" id="imageHint">Image space (optional)</span>
      </div>

      <!-- Miner text -->
      <p class="miner-text" id="minerText">Loading dialogue...</p>

      <!-- Options -->
      <div class="options" id="options"></div>

      <div class="row">
        <button class="small-btn" id="restartBtn" type="button">Restart</button>
        <span class="muted" id="debugNode"></span>
      </div>
    </div>

    <script> 

      /*
        Put your dialogue JSON next to this HTML file, for example:
          - test.json

        If the filename is different, change DIALOGUE_URL below.
      */
      const DIALOGUE_URL = "dialoguetrees/test.json"; //rewrite this to load in the correct json file for the selected statue!

      let dialogue = null;
      let currentNodeId = "start";

      const minerTextEl = document.getElementById("minerText");
      const optionsEl = document.getElementById("options");
      const restartBtn = document.getElementById("restartBtn");
      const debugNodeEl = document.getElementById("debugNode");

      // Optional: set an image URL here if you want a picture to appear
      // Example: const MINER_IMAGE_URL = "miner.jpg";
      const MINER_IMAGE_URL = "./assets/statues/" + parent.GetCurrentlySelectedPOI() + ".jpg";

      const minerImgEl = document.getElementById("minerImg");
      const imageHintEl = document.getElementById("imageHint");

      function setupImage() {
        if (MINER_IMAGE_URL && typeof MINER_IMAGE_URL === "string") {
          minerImgEl.src = MINER_IMAGE_URL;
          minerImgEl.style.display = "block";
          imageHintEl.style.display = "none";
        } else {
          minerImgEl.removeAttribute("src");
          minerImgEl.style.display = "none";
          imageHintEl.style.display = "block";
        }
      }

      function safeGetNode(id) {
        if (!dialogue) return null;
        const node = dialogue[id];
        return node || null;
      }

      function setNode(id) {
        const node = safeGetNode(id);
        if (!node) {
          // Fallback: if something goes wrong, go to end or start
          currentNodeId = dialogue && dialogue.end ? "end" : "start";
        } else {
          currentNodeId = id;
        }
        render();
      }

      function clearOptions() {
        while (optionsEl.firstChild) optionsEl.removeChild(optionsEl.firstChild);
      }

      function addOptionButton(label, nextId) {
        const btn = document.createElement("button");
        btn.type = "button";
        btn.textContent = label;
        btn.addEventListener("click", () => setNode(nextId));
        optionsEl.appendChild(btn);
      }

      function render() {
        const node = safeGetNode(currentNodeId);

        if (!node) {
          minerTextEl.textContent = "Dialogue node not found. Restarting.";
          clearOptions();
          addOptionButton("Restart", "start");
          return;
        }

        minerTextEl.textContent = node.text || "";

        clearOptions();

        const opts = Array.isArray(node.options) ? node.options : [];

        if (opts.length === 0) {
          // No dead ends: always offer a way forward
          if (currentNodeId !== "start") {
            addOptionButton("Restart conversation", "start");
          } else {
            // If start somehow has no options, route to end
            addOptionButton("Continue", "end");
          }
        } else {
          for (const opt of opts) {
            if (!opt || typeof opt.text !== "string" || typeof opt.next !== "string") continue;
            addOptionButton(opt.text, opt.next);
          }

          // Safety net: if all options were invalid, still provide a path
          if (optionsEl.childElementCount === 0) {
            addOptionButton("Restart conversation", "start");
          }
        }

        debugNodeEl.textContent = "Node: " + currentNodeId;
      }

      async function init() {
        setupImage();

        try {
          const res = await fetch(DIALOGUE_URL, { cache: "no-store" });
          if (!res.ok) throw new Error("HTTP " + res.status);
          dialogue = await res.json();

          // If the JSON has no "start", pick the first key as a fallback
          if (!dialogue.start) {
            const keys = Object.keys(dialogue);
            currentNodeId = keys.includes("start") ? "start" : (keys[0] || "start");
          } else {
            currentNodeId = "start";
          }

          render();
        } catch (err) {
          minerTextEl.textContent =
            "Could not load dialogue JSON. Make sure " +
            DIALOGUE_URL +
            " is in the same folder and served by your web server.";
          clearOptions();
          addOptionButton("Retry", "start");
          console.error(err);
        }
      }

      restartBtn.addEventListener("click", () => setNode("start"));

      init(); 
    </script>
  </body>
</html>
